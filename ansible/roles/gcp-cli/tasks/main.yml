---
- name: Determine if GCP gpg keyring already exists
  stat:
    path: "{{ gcp_gpg_keyring }}"
  register: gcp_gpg_keyring_file
  tags: gcp-cli

- name: Download armored GCP GPG key
  ansible.builtin.get_url:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    dest: /tmp/gcp-keyring.asc
    mode: '0644'
  when: not gcp_gpg_keyring_file.stat.exists
  register: armored_gcp_gpg_key_downloaded
  tags: gcp-cli

- name: Convert GCP GPG key to binary form
  ansible.builtin.command: gpg --dearmor -o {{ gcp_gpg_keyring }} /tmp/gcp-keyring.asc
  when: armored_gcp_gpg_key_downloaded.changed
  tags: gcp-cli

- name: Remove armored GCP GPG key
  ansible.builtin.file:
    path: /tmp/gcp-keyring.asc
    state: absent
  when: armored_gcp_gpg_key_downloaded.changed
  tags: gcp-cli

- name: Install GCP source definition file
  ansible.builtin.copy:
    src: google-cloud-sdk.list
    dest: /etc/apt/sources.list.d/google-cloud-sdk.list
    mode: '0644'
  register: gcp_source
  tags: gcp-cli

- name: Update apt sources
  ansible.builtin.command: apt-get update
  when: gcp_source.changed
  tags: gcp-cli

- name: Install Google Cloud packages
  ansible.builtin.apt:
    name: '{{ gcp_apt_packages }}'
    state: present
  tags: gcp-cli
