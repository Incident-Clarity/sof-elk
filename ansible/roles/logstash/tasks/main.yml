---
# TODO: for some reason this is not working right now
- name: Install Logstash
  ansible.builtin.apt:
#    name: logstash={{ elastic_stack_version }}
    name: logstash
    state: present
  tags: sof-elk_logstash

# TODO: this may not be needed since we previously installed the dpkg trigger
- name: Install Logstash Plugins
  community.general.logstash_plugin:
    name: '{{ item }}'
    state: present
  with_items:
    - logstash-input-relp
    - logstash-input-google_pubsub
    - logstash-filter-tld
    - logstash-filter-rest
    - logstash-filter-json_encode
  register: logstash_plugins
  tags: sof-elk_logstash

- name: Set Logstash JVM options
  ansible.builtin.lineinfile:
    dest: '/etc/logstash/jvm.options'
    regexp: "^{{ item.parameter | regex_escape() }}"
    line: "{{ item.parameter }}{{ item.value }}"
  with_items:
    - { parameter: '-Xms', value: '750m' }
    - { parameter: '-Xss', value: '4m' }
  register: logstash_jvm_config
  tags: sof-elk_logstash

- name: Get list of all configfiles
  ansible.builtin.find:
    paths: '/usr/local/sof-elk/configfiles/'
    file_type: file
  register: configfile_results
  tags: sof-elk_logstash

- name: Set symlinks for pipeline configuration
  ansible.builtin.file:
    state: link
    src: '/usr/local/sof-elk/configfiles/{{ item.path | basename }}'
    dest: '/etc/logstash/conf.d/{{ item.path | basename }}'
  with_items:
    - '{{ configfile_results.files }}'
  register: logstash_config_symlinks
  tags: sof-elk_logstash

- name: Configure Logstash
  ansible.builtin.copy:
    src: 'logstash.yml'
    dest: '/etc/logstash/logstash.yml'
    owner: root
    group: root
    mode: 0644
  register: logstash_config
  tags: sof-elk_logstash

- name: Start and Enable Logstash service
  ansible.builtin.systemd:
    name: logstash
    enabled: yes
    state: started
  register: enablestart_logstash
  tags: sof-elk_logstash

- name: Restart Logstash
  ansible.builtin.systemd:
    name: logstash
    state: restarted
  when: (not enablestart_logstash) and (logstash_plugins.changed or logstash_jvm_config.changed or logstash_config_symlinks.changed or logstash_config.changed)
  tags: sof-elk_logstash
